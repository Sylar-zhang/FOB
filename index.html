<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>海外FOB/毛利率计算器</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#050505">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FOB计算器">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root {
  --bg-body: #050505;
  --bg-card: #111111;
  --bg-input: #1a1a1a;
  --bg-hover: #222222;
  --border-color: #333333;
  --border-focus: #666666;
  --text-main: #e5e5e5;
  --text-muted: #b0b0b0;
  --text-highlight: #ffffff;
  --radius: 8px;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  height: 100dvh;
  width: 100vw;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  display: flex;
  justify-content: center;
}

.box {
  width: 100%;
  max-width: 500px;
  height: 100%;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  background-color: var(--bg-card);
}

@media (min-width: 501px) {
  body { align-items: center; background: #000; }
  .box {
    height: auto;
    max-height: 92vh;
    border-radius: 12px;
    border: 1px solid var(--border-color);
  }
}

h2 {
  text-align: center;
  font-size: 15px;
  font-weight: 500;
  letter-spacing: 1px;
  margin: 0;
  padding: 8px 0 10px 0;
  color: var(--text-highlight);
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
}

.inputs {
  flex: 1; 
  display: flex;
  flex-direction: column;
  justify-content: space-evenly; 
  padding: 6px 0;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.group {
  display: flex;
  flex-direction: column;
}

label {
  font-size: 10px;
  color: var(--text-muted);
  margin-bottom: 3px;
  padding-left: 2px;
}

input, .dropdown-value {
  width: 100%;
  height: 36px;
  padding: 0 10px;
  font-size: 14px;
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
  background: var(--bg-input);
  color: var(--text-main);
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.dropdown-value {
  justify-content: space-between;
  text-align: left;
}
.dropdown-value::after { content: "▾"; font-size: 10px; color: var(--text-muted); }

input:focus {
  border-color: var(--border-focus);
  background: var(--bg-hover);
}

.dropdown { position: relative; width: 100%; }
.dropdown-menu {
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: #1f1f1f;
  border: 1px solid var(--border-focus);
  border-radius: var(--radius);
  z-index: 100;
  display: none;
}
.dropdown.open .dropdown-menu { display: block; }
.dropdown-item {
  padding: 10px;
  font-size: 13px;
  text-align: center;
  border-bottom: 1px solid #333;
}
.dropdown-item.active { background: #333; color: #fff; }

.result {
  flex-shrink: 0;
  padding: 10px 12px;
  border-radius: var(--radius);
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.cost-row {
  display: flex;
  justify-content: space-between;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 2px;
}

.block {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.block-title {
  font-size: 10px;
  color: #555;
  margin-bottom: 2px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.block-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  line-height: 1.4;
}

.highlight { color: var(--text-highlight); font-weight: 600; }
.accent { color: #fff; font-weight: normal; } 

.footer {
  flex-shrink: 0;
  text-align: center;
  font-size: 9px;
  margin-top: 8px;
  color: #333;
}
</style>
</head>

<body>
<div class="box">
  <h2>海外FOB/毛利率计算器</h2>

  <div class="inputs">
    <div class="grid">
      <div class="group" style="width:100%">
        <label>成本类型</label>
        <div class="dropdown" id="costTypeBox">
          <div class="dropdown-value" id="costTypeValue">含税成本</div>
          <div class="dropdown-menu">
            <div class="dropdown-item active" data-value="tax">含税成本</div>
            <div class="dropdown-item" data-value="notax">未税成本</div>
          </div>
        </div>
      </div>
      <div class="group">
        <label>成本 RMB</label>
        <input id="cost" type="number" inputmode="decimal">
      </div>
    </div>

    <div class="grid">
      <div class="group"><label>税率 %</label><input id="taxRate" type="number" inputmode="decimal"></div>
      <div class="group"><label>汇率</label><input id="rate" type="number" inputmode="decimal"></div>
    </div>

    <div class="grid">
      <div class="group"><label>OCOGS %</label><input id="ocogs" type="number" inputmode="decimal"></div>
      <div class="group"><label>返点 %</label><input id="rebate" type="number" inputmode="decimal"></div>
    </div>

    <div class="grid">
      <div class="group"><label>固定扣点 %</label><input id="fixed" type="number" inputmode="decimal"></div>
      <div class="group"><label>目标毛利率 %</label><input id="margin" type="number" inputmode="decimal"></div>
    </div>

    <div class="group">
      <label>FOB USD（反算毛利）</label>
      <input id="fob" type="number" inputmode="decimal">
    </div>
  </div>

  <div class="result" id="result">
    <div style="text-align:center; opacity:0.5; padding: 10px 0;">等待输入...</div>
  </div>
  
  <div class="footer">仅限张嘉琛使用</div>
</div>

<script>
const STORE_KEY = "FOB_MARGIN_CALC_V1";
let costType = "tax";
const $ = id => document.getElementById(id);

/* --- Service Worker Registration --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('SW Registered'))
      .catch(err => console.log('SW Error:', err));
  });
}

function saveData() {
  const data = {
    costType,
    cost: $("cost").value,
    taxRate: $("taxRate").value,
    rate: $("rate").value,
    ocogs: $("ocogs").value,
    rebate: $("rebate").value,
    fixed: $("fixed").value,
    margin: $("margin").value,
    fob: $("fob").value
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
}

function loadData() {
  const raw = localStorage.getItem(STORE_KEY);
  if (!raw) return;
  try {
    const d = JSON.parse(raw);
    costType = d.costType || "tax";
    $("cost").value = d.cost || "";
    $("taxRate").value = d.taxRate || "";
    $("rate").value = d.rate || "";
    $("ocogs").value = d.ocogs || "";
    $("rebate").value = d.rebate || "";
    $("fixed").value = d.fixed || "";
    $("margin").value = d.margin || "";
    $("fob").value = d.fob || "";

    $("costTypeValue").textContent = costType === "tax" ? "含税成本" : "未税成本";
    
    document.querySelectorAll(".dropdown-item").forEach(i => {
      i.classList.toggle("active", i.dataset.value === costType);
    });

    if($("cost").value) calc();
  } catch {}
}

function calc() {
  saveData();

  const c = +$("cost").value;
  const t = +$("taxRate").value / 100;
  const r = +$("rate").value;
  const o = +$("ocogs").value / 100;
  const rb = +$("rebate").value / 100;
  const fx = +$("fixed").value / 100;
  const mg = +$("margin").value / 100;
  const f = +$("fob").value;

  if (!c || !r) {
    $("result").innerHTML = '<div style="text-align:center; opacity:0.5; padding: 10px 0;">等待输入...</div>';
    return;
  }

  const untaxed = costType === "tax" ? c / (1 + t) : c;
  const costUSD = untaxed * (1 + o) / r;

  let html = `
    <div class="cost-row">
      <span>基础销售成本</span>
      <span class="accent">${costUSD.toFixed(4)} USD</span>
    </div>
  `;

  if (mg > 0) {
    const fobT = costUSD * (1 - fx) / ((1 - rb) * (1 - mg - fx));
    html += `
    <div class="block">
      <div class="block-title">方案一：按目标毛利率推算</div>
      <div class="block-row">
        <span>目标毛利率</span>
        <span>${(mg * 100).toFixed(2)}%</span>
      </div>
      <div class="block-row">
        <span>建议 FOB 报价</span>
        <span class="highlight">${fobT.toFixed(2)} USD</span>
      </div>
    </div>`;
  }

  if (f > 0) {
    const customerCost = f * (1 - rb);
    const realMargin = 1 - (costUSD + (customerCost - costUSD) * fx) / customerCost;
    html += `
    <div class="block">
      <div class="block-title" style="margin-top:4px; border-top:1px dashed #333; padding-top:4px;">方案二：按 FOB 价格反算</div>
      <div class="block-row">
        <span>设定 FOB 价格</span>
        <span>${f.toFixed(2)} USD</span>
      </div>
      <div class="block-row">
        <span>实际毛利率</span>
        <span class="highlight">${(realMargin * 100).toFixed(2)}%</span>
      </div>
    </div>`;
  }

  $("result").innerHTML = html;
}

document.querySelectorAll("input").forEach(i => i.oninput = calc);

$("costTypeBox").onclick = e => {
  e.stopPropagation();
  e.currentTarget.classList.toggle("open");
};

document.querySelectorAll(".dropdown-item").forEach(i => {
  i.onclick = () => {
    costType = i.dataset.value;
    $("costTypeValue").textContent = i.textContent;
    document.querySelectorAll(".dropdown-item").forEach(x => x.classList.remove("active"));
    i.classList.add("active");
    $("costTypeBox").classList.remove("open");
    calc();
  };
});

document.onclick = () => $("costTypeBox").classList.remove("open");

loadData();
</script>
</body>
</html>
